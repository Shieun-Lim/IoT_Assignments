<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>My MQTT Page</title>

    <!-- MQTT WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
</head>

<body>
<h3>ë‚˜ì˜ ì›¹ (0317137263 ì„¼ì„œ ë°ì´í„° í‘œì‹œ)</h3>
<div id="main" style="font-size:20px; white-space: pre-wrap;"></div>

<script>
    // WSS ë¸Œë¡œì»¤ ì£¼ì†Œ
    const brokerUrl = 'wss://damoa.io:9002';

    // ëœë¤ clientId ìƒì„±
    const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);

    // MQTT ì˜µì…˜
    const options = {
        clientId: clientId,
        clean: true,
        connectTimeout: 4000,
        reconnectPeriod: 2000,
        protocol: 'wss'
    };

    console.log("ë¸Œë¡œì»¤ ì—°ê²° ì‹œë„:", brokerUrl);

    // MQTT ë¸Œë¡œì»¤ ì ‘ì†
    const client = mqtt.connect(brokerUrl, options);

    // ì—°ê²° ì„±ê³µ ì‹œ
    client.on('connect', () => {
        console.log("ì ‘ì† ì„±ê³µ!", clientId);

        // ğŸ‘‰ êµ¬ë…í•´ì•¼ í•  ì‹¤ì œ í† í”½
        const topic = "ewha/0317137263";

        client.subscribe(topic, err => {
            if (!err) {
                console.log("êµ¬ë… ì„±ê³µ:", topic);

                // (ì„ íƒ) ì²´í¬ì¸ ë©”ì‹œì§€ ë°œí–‰
                client.publish("ewha/checkin", "ì›¹ ì ‘ì† ì™„ë£Œ");
            } else {
                console.error("êµ¬ë… ì˜¤ë¥˜:", err);
            }
        });
    });

    // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì‹¤í–‰
    client.on('message', (topic, message) => {
        const msg = message.toString();
        console.log("ë°›ì€ ë©”ì‹œì§€:", msg);

        // HTMLì— í‘œì‹œ
        document.getElementById("main").innerText = msg;
    });

    // ì—°ê²° ì˜¤ë¥˜ ì²˜ë¦¬
    client.on('error', (err) => {
        console.error("MQTT ì—°ê²° ì˜¤ë¥˜:", err);
    });
</script>

</body>
</html>
