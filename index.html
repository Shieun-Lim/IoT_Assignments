<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>My</title>
    <h3>ë‚˜ì˜ ì›¹(2593249, ì„ì‹œì€)</h3>

    <!-- MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // MQTT ë¸Œë¡œì»¤ (ws:// â€” HTTPS í™˜ê²½ì—ì„œëŠ” ì°¨ë‹¨ë¨)
        const brokerUrl = 'ws://damoa.io:9002';

        // ê³ ìœ í•œ í´ë¼ì´ì–¸íŠ¸ ID ìƒì„±
        const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);

        const options = {
            clientId: clientId
        };

        console.log(`MQTT ë¸Œë¡œì»¤(${brokerUrl})ì— ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤...`);
        const client = mqtt.connect(brokerUrl, options);

        // 1. MQTT ì ‘ì† ì„±ê³µ
        client.on('connect', () => {
            console.log(`âœ… ì ‘ì† ì„±ê³µ! (í´ë¼ì´ì–¸íŠ¸ ID: ${clientId})`);

            // ì‹¤ì œ ì„¼ì„œ í† í”½ìœ¼ë¡œ êµ¬ë… (MQTT Explorer ê¸°ë°˜)
            const topic = `ewha/0317137263`;
            client.subscribe(topic, (err) => {
                if (!err) {
                    console.log(`ğŸ“„ í† í”½ êµ¬ë… ì„±ê³µ: ${topic}`);

                    // ì²´í¬ì¸ ë©”ì‹œì§€ ë°œí–‰ (ê³¼ì œìš©)
                    client.publish('ewha/checkin', "2593249 ì„ì‹œì€");
                } else {
                    console.error('í† í”½ êµ¬ë… ì˜¤ë¥˜:', err);
                }
            });
        });

        // 2. ë©”ì‹œì§€ ìˆ˜ì‹ 
        client.on('message', (topic, message) => {
            console.log(`${topic} â†’ ${message.toString()}`);

            const mainDiv = document.getElementById('main');

            const messageHTML = `
                <div class="message-item">
                    <span>${message.toString()}</span>
                </div>
            `;

            // ìµœì‹  ë©”ì‹œì§€ë§Œ í‘œì‹œ
            mainDiv.innerHTML = messageHTML;
        });

        // 3. ì˜¤ë¥˜ ì²˜ë¦¬
        client.on('error', (err) => {
            console.error('ì—°ê²° ì˜¤ë¥˜:', err);
            client.end();
        });
    </script>

</head>

<body>
    <div id="main" style="font-size:20px; margin-top:20px;">
        ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦
    </div>
</body>
</html>
